<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-900">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hiragana & Big Number Quiz</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Use Inter font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Style for the main character display */
        .kana-char {
            font-size: 10rem; /* Large font size for the character */
            line-height: 1;
            color: white;
            margin-bottom: 1.5rem;
            text-align: center;
            overflow-wrap: break-word; /* Allows long numbers to wrap */
        }
        /* Custom focus styles for accessibility and design */
        .form-input:focus {
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.5);
            outline: none;
        }
    </style>
</head>
<body class="h-full flex items-center justify-center p-4 bg-gray-900 text-gray-100">

    <div id="app" class="w-full max-w-md mx-auto">
        <h1 class="text-3xl font-bold text-center text-indigo-400 mb-6">Japanese Quiz Master</h1>

        <!-- Mode Selection Screen -->
        <div id="mode-selection" class="flex flex-col space-y-4">
            <button id="hiragana-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg text-lg transition duration-200 shadow-lg">
                Hiragana Quiz
            </button>
            <button id="katakana-btn" class="w-full bg-pink-600 hover:bg-pink-700 text-white font-bold py-3 px-4 rounded-lg text-lg transition duration-200 shadow-lg">
                Katakana Quiz
            </button>
            
            <!-- Updated Number Generator Button -->
            <button id="number-quiz-btn" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-lg text-lg transition duration-200 shadow-lg">
                Big Numbers (Up to Chou)
            </button>

            <p class="text-center text-gray-400 text-sm pt-4">by Elijah M.</p>
        </div>

        <!-- Hiragana Row Selection -->
        <div id="hiragana-row-selection" class="hidden">
            <h2 class="text-2xl font-bold text-center text-indigo-400 mb-4">Select Hiragana Rows</h2>
            <div class="flex flex-col space-y-3">
                <button id="quiz-all-hiragana-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg text-lg transition duration-200 shadow-lg">
                    Quiz All Hiragana
                </button>
                <button id="quiz-main-hiragana-btn" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg text-lg transition duration-200 shadow-lg">
                    Quiz Main Characters
                </button>
                <button id="quiz-daku-hiragana-btn" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg text-lg transition duration-200 shadow-lg">
                    Quiz Dakuten & Handakuten
                </button>
                <button id="hiragana-back-btn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-lg transition duration-200 mt-2">
                    Back to Main Menu
                </button>
            </div>
        </div>

        <!-- Katakana Row Selection -->
        <div id="katakana-row-selection" class="hidden">
            <h2 class="text-2xl font-bold text-center text-pink-400 mb-4">Select Katakana Rows</h2>
            <div class="flex flex-col space-y-3">
                <button id="quiz-all-katakana-btn" class="w-full bg-pink-600 hover:bg-pink-700 text-white font-bold py-3 px-4 rounded-lg text-lg transition duration-200 shadow-lg">
                    Quiz All Katakana
                </button>
                <button id="quiz-main-katakana-btn" class="w-full bg-pink-500 hover:bg-pink-600 text-white font-bold py-3 px-4 rounded-lg text-lg transition duration-200 shadow-lg">
                    Quiz Main Characters
                </button>
                <button id="quiz-daku-katakana-btn" class="w-full bg-pink-500 hover:bg-pink-600 text-white font-bold py-3 px-4 rounded-lg text-lg transition duration-200 shadow-lg">
                    Quiz Dakuten & Handakuten
                </button>
                <button id="katakana-back-btn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-lg transition duration-200 mt-2">
                    Back to Main Menu
                </button>
            </div>
        </div>

        <!-- Quiz Screen (Initially hidden) -->
        <div id="quiz-screen" class="hidden">
            <!-- Score and Stats -->
            <div class="flex justify-between items-center mb-4 text-lg">
                <div class="font-medium">Score: <span id="score" class="font-bold text-green-400">0</span></div>
                <div class="font-medium">Progress: <span id="progress" class="font-bold text-indigo-400">0 / 0</span></div>
            </div>

            <!-- Main Character Display -->
            <div class="bg-gray-800 rounded-lg shadow-2xl p-8 flex flex-col items-center">
                <div id="char-display" class="kana-char">あ</div>
                
                <!-- Answer Form -->
                <form id="quiz-form" class="w-full">
                    <label for="answer-input" class="block text-sm font-medium text-gray-300 mb-2 text-center">Type the answer in hiragana or romaji</label>
                    <input type="text" id="answer-input" name="answer-input" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"
                           class="form-input w-full text-center text-2xl bg-gray-900 border-2 border-gray-700 text-white rounded-lg py-3 px-4 transition duration-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500"
                           placeholder="e.g. 'せん' or 'sen'">
                    <!-- The form submits on Enter or with the button -->
                </form>

                <!-- Button Container -->
                <div class="flex w-full space-x-2 mt-4">
                    <!-- Hint Button -->
                    <button type="button" id="hint-btn" class="flex-1 bg-yellow-600 hover:bg-yellow-700 text-white font-medium py-2 px-4 rounded-lg transition duration-200 text-sm">
                        Show Hint
                    </button>
                    <!-- Submit Button -->
                    <button type="submit" form="quiz-form" id="submit-btn" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition duration-200 text-sm">
                        Submit
                    </button>
                </div>

                <!-- Hint Display -->
                <div id="hint-display" class="mt-3 h-6 text-lg font-medium text-center text-yellow-400">&nbsp;</div>

                <!-- Feedback Message -->
                <div id="feedback" class="mt-2 h-6 text-lg font-medium text-center">&nbsp;</div>
            </div>
            
            <!-- Quit Button -->
            <button id="quit-btn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-lg transition duration-200 mt-6">
                Back to Menu
            </button>
        </div>

        <!-- Final Score Screen (Initially hidden) -->
        <div id="results-screen" class="hidden text-center">
            <h2 class="text-2xl font-bold mb-4">Quiz Complete!</h2>
            <div class="text-4xl font-bold mb-6">Final Score: <span id="final-score" class="text-green-400">0</span> / <span id="total-questions">0</span></div>
            
            <div class="flex flex-col space-y-4">
                <button id="repeat-all-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg text-lg transition duration-200 shadow-lg">
                    Repeat All
                </button>
                <button id="repeat-mistakes-btn" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-4 rounded-lg text-lg transition duration-200 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                    Practice Mistakes (0)
                </button>
                <button id="main-menu-btn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-lg transition duration-200 mt-2">
                    Back to Main Menu
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- DATA ---
        
        const hiraganaData = {
            'あ': 'a', 'い': 'i', 'う': 'u', 'え': 'e', 'お': 'o',
            'か': 'ka', 'き': 'ki', 'く': 'ku', 'け': 'ke', 'こ': 'ko',
            'さ': 'sa', 'し': 'shi', 'す': 'su', 'せ': 'se', 'そ': 'so',
            'た': 'ta', 'ち': 'chi', 'つ': 'tsu', 'て': 'te', 'と': 'to',
            'な': 'na', 'に': 'ni', 'ぬ': 'nu', 'ね': 'ne', 'の': 'no',
            'は': 'ha', 'ひ': 'hi', 'ふ': 'fu', 'へ': 'he', 'ほ': 'ho',
            'ま': 'ma', 'み': 'mi', 'む': 'mu', 'め': 'me', 'も': 'mo',
            'や': 'ya', 'ゆ': 'yu', 'よ': 'yo',
            'ら': 'ra', 'り': 'ri', 'る': 'ru', 'れ': 're', 'ろ': 'ro',
            'わ': 'wa', 'を': 'wo',
            'ん': 'n',
            'が': 'ga', 'ぎ': 'gi', 'ぐ': 'gu', 'げ': 'ge', 'ご': 'go',
            'ざ': 'za', 'じ': 'ji', 'ず': 'zu', 'ぜ': 'ze', 'ぞ': 'zo',
            'だ': 'da', 'ぢ': 'ji', 'づ': 'zu', 'で': 'de', 'ど': 'do',
            'ば': 'ba', 'び': 'bi', 'ぶ': 'bu', 'べ': 'be', 'ぼ': 'bo',
            'ぱ': 'pa', 'ぴ': 'pi', 'ぷ': 'pu', 'ぺ': 'pe', 'ぽ': 'po',
            'きゃ': 'kya', 'きゅ': 'kyu', 'きょ': 'kyo',
            'しゃ': 'sha', 'しゅ': 'shu', 'しょ': 'sho',
            'ちゃ': 'cha', 'ちゅ': 'chu', 'ちょ': 'cho',
            'にゃ': 'nya', 'にゅ': 'nyu', 'にょ': 'nyo',
            'ひゃ': 'hya', 'ひゅ': 'hyu', 'ひょ': 'hyo',
            'みゃ': 'mya', 'みゅ': 'myu', 'みょ': 'myo',
            'りゃ': 'rya', 'りゅ': 'ryu', 'りょ': 'ryo',
            'ぎゃ': 'gya', 'ぎゅ': 'gyu', 'ぎょ': 'gyo',
            'じゃ': 'ja', 'じゅ': 'ju', 'じょ': 'jo',
            'びゃ': 'bya', 'びゅ': 'byu', 'びょ': 'byo',
            'ぴゃ': 'pya', 'ぴゅ': 'pyu', 'ぴょ': 'pyo'
        };

        const katakanaData = {
            'ア': 'a', 'イ': 'i', 'ウ': 'u', 'エ': 'e', 'オ': 'o',
            'カ': 'ka', 'キ': 'ki', 'ク': 'ku', 'ケ': 'ke', 'コ': 'ko',
            'サ': 'sa', 'シ': 'shi', 'ス': 'su', 'セ': 'se', 'ソ': 'so',
            'タ': 'ta', 'チ': 'chi', 'ツ': 'tsu', 'テ': 'te', 'ト': 'to',
            'ナ': 'na', 'ニ': 'ni', 'ヌ': 'ヌ', 'ネ': 'ne', 'ノ': 'no',
            'ハ': 'ha', 'ヒ': 'hi', 'フ': 'fu', 'ヘ': 'he', 'ホ': 'ho',
            'マ': 'ma', 'ミ': 'mi', 'ム': 'mu', 'メ': 'me', 'モ': 'mo',
            'ヤ': 'ya', 'ユ': 'yu', 'ヨ': 'yo',
            'ラ': 'ra', 'リ': 'ri', 'ル': 'ru', 'レ': 're', 'ロ': 'ro',
            'ワ': 'wa', 'ヲ': 'wo',
            'ン': 'n',
            'ガ': 'ga', 'ギ': 'gi', 'グ': 'gu', 'ゲ': 'ge', 'ゴ': 'go',
            'ザ': 'za', 'ジ': 'ji', 'ズ': 'zu', 'ゼ': 'ze', 'ゾ': 'zo',
            'ダ': 'da', 'ヂ': 'ji', 'ヅ': 'zu', 'デ': 'de', 'ド': 'do',
            'バ': 'ba', 'ビ': 'bi', 'ブ': 'bu', 'ベ': 'be', 'ボ': 'bo',
            'パ': 'pa', 'ピ': 'pi', 'プ': 'pu', 'ペ': 'pe', 'ポ': 'po',
            'キャ': 'kya', 'キュ': 'kyu', 'キョ': 'kyo',
            'シャ': 'sha', 'シュ': 'shu', 'ショ': 'sho',
            'チャ': 'cha', 'チュ': 'chu', 'チョ': 'cho',
            'ニャ': 'nya', 'ニュ': 'nyu', 'ニョ': 'nyo',
            'ヒャ': 'hya', 'ヒュ': 'hyu', 'ヒョ': 'hyo',
            'ミャ': 'mya', 'ミュ': 'myu', 'ミョ': 'myo',
            'リャ': 'rya', 'リュ': 'ryu', 'リョ': 'ryo',
            'ギャ': 'gya', 'ギュ': 'gyu', 'ギョ': 'gyo',
            'ジャ': 'ja', 'ジュ': 'ju', 'ジョ': 'jo',
            'ビャ': 'bya', 'ビュ': 'byu', 'ビョ': 'byo',
            'ピャ': 'pya', 'ピュ': 'pyu', 'ピョ': 'pya'
        };

        const mainHiraganaChars = Object.keys(hiraganaData).filter(k => k.length < 2 && !('がざだばぱ'.includes(k.slice(-1))));
        const mainKatakanaChars = Object.keys(katakanaData).filter(k => k.length < 2 && !('ガザダバパ'.includes(k.slice(-1))));
        const dakuHiraganaChars = Object.keys(hiraganaData).filter(k => 'がざだばぱ'.includes(k.slice(-1)) || k.length > 2);
        const dakuKatakanaChars = Object.keys(katakanaData).filter(k => 'ガザダバパ'.includes(k.slice(-1)) || k.length > 2);
        
        // --- Big Number Generator Logic (Updated for Hiragana and Chou) ---

        /**
         * Converts a number into its continuous Japanese Hiragana reading, up to 10 Trillion.
         * Handles major euphony rules for 100s and 1000s.
         * @param {number} num - The number to convert (must be safe integer).
         * @returns {string} The hiragana spelling.
         */
        function convertToJapaneseHiragana(num) {
            if (num === 0) return 'ゼロ'; // Using zero for simplicity

            const h_digits = ['', 'いち', 'に', 'さん', 'よん', 'ご', 'ろく', 'なな', 'はち', 'きゅう'];
            const h_units_large = ['', 'まん', 'おく', 'ちょう']; // Man, Oku, Chou

            let parts = [];
            let unitIndex = 0; // 0: base (1-9999), 1: man, 2: oku, 3: chou

            // Use BigInt for numbers larger than 2^53 - 1 to ensure precision in calculations
            let currentNum = BigInt(num);

            while (currentNum > 0n && unitIndex < h_units_large.length) {
                let chunk = Number(currentNum % 10000n);
                currentNum /= 10000n;

                if (chunk > 0) {
                    let chunkHiragana = '';
                    
                    let thousands = Math.floor(chunk / 1000);
                    let hundreds = Math.floor((chunk % 1000) / 100);
                    let tens = Math.floor((chunk % 100) / 10);
                    let ones = chunk % 10;

                    // 1. Thousands (せん)
                    if (thousands === 1) chunkHiragana += 'せん';
                    else if (thousands === 3) chunkHiragana += 'さんぜん'; // 3000
                    else if (thousands === 8) chunkHiragana += 'はっせん'; // 8000 (double consonant)
                    else if (thousands > 1) chunkHiragana += h_digits[thousands] + 'せん';

                    // 2. Hundreds (ひゃく)
                    if (hundreds === 1) chunkHiragana += 'ひゃく';
                    else if (hundreds === 3) chunkHiragana += 'さんびゃく'; // 300
                    else if (hundreds === 6) chunkHiragana += 'ろっぴゃく'; // 600 (double consonant)
                    else if (hundreds === 8) chunkHiragana += 'はっぴゃく'; // 800 (double consonant)
                    else if (hundreds > 1) chunkHiragana += h_digits[hundreds] + 'ひゃく';

                    // 3. Tens (じゅう)
                    if (tens === 1) chunkHiragana += 'じゅう';
                    else if (tens > 1) chunkHiragana += h_digits[tens] + 'じゅう';

                    // 4. Ones (いち-きゅう)
                    if (ones > 0) chunkHiragana += h_digits[ones];

                    // 5. Large Units (まん, おく, ちょう)
                    let unitSuffix = h_units_large[unitIndex];
                    
                    if (unitIndex > 0) {
                        if (chunk === 1) {
                            // 10,000, 100,000,000, 1,000,000,000,000
                            // Special case: ichiman, ichioku, icchou (or ichichou, using ichi for simplicity)
                            chunkHiragana = 'いち' + unitSuffix;
                        } else if (unitSuffix) {
                            // 20,000 is 'にまん' (niman).
                            // The `h_digits[ones]` value needs to be removed if it's the only one left in the chunk for units 
                            // that require it (like 10000), but the structure above mostly handles it by building the string.
                            chunkHiragana += unitSuffix;
                        }
                    }

                    parts.unshift(chunkHiragana);
                }

                unitIndex++;
            }

            return parts.join('');
        }

        /**
         * Generates random numbers up to 10 trillion for the quiz.
         */
        function generateBigNumberData(count = 15) {
            const data = {};
            const usedNumbers = new Set();
            const MAX_CHOU = 10000000000000n; // Up to 10 Trillion

            for (let i = 0; i < count; i++) {
                let numBigInt;
                
                // Generate a number using BigInt for safety
                const type = Math.random();
                
                if (type < 0.25) {
                    // Small-ish (1 - 9999)
                    numBigInt = BigInt(Math.floor(Math.random() * 9900) + 1); 
                } else if (type < 0.5) {
                    // Man range (10,000 - 99,999,999), prioritize round numbers
                    const man = BigInt(Math.floor(Math.random() * 9900) + 1);
                    numBigInt = man * 10000n;
                } else if (type < 0.75) {
                    // Oku range (100,000,000 - 9,999,999,999), prioritize round numbers
                    const oku = BigInt(Math.floor(Math.random() * 99) + 1);
                    numBigInt = oku * 100000000n;
                    if (Math.random() > 0.5) numBigInt += BigInt(Math.floor(Math.random() * 99)) * 10000n; // Add some man
                } else {
                    // Chou range (1,000,000,000,000 to MAX_CHOU)
                    const chou = BigInt(Math.floor(Math.random() * 99) + 1);
                    numBigInt = chou * 1000000000000n;
                    if (Math.random() > 0.5) numBigInt += BigInt(Math.floor(Math.random() * 99)) * 100000000n; // Add some oku
                }
                
                if (numBigInt === 0n || numBigInt > MAX_CHOU) {
                    i--;
                    continue;
                }
                
                // Avoid dupes
                if (usedNumbers.has(numBigInt.toString())) {
                    i--;
                    continue;
                }
                usedNumbers.add(numBigInt.toString());

                // Format number with commas for display
                const displayNum = numBigInt.toLocaleString('en-US'); // Use US locale for digit grouping
                const answer = convertToJapaneseHiragana(Number(numBigInt));
                
                data[displayNum] = answer;
            }
            return data;
        }


        // --- DOM Elements ---
        const modeSelection = document.getElementById('mode-selection');
        const quizScreen = document.getElementById('quiz-screen');
        const resultsScreen = document.getElementById('results-screen');
        
        const hiraganaRowSelection = document.getElementById('hiragana-row-selection');
        const katakanaRowSelection = document.getElementById('katakana-row-selection');
        
        const hiraganaBackBtn = document.getElementById('hiragana-back-btn');
        const katakanaBackBtn = document.getElementById('katakana-back-btn');
        const quizAllHiraganaBtn = document.getElementById('quiz-all-hiragana-btn');
        const quizAllKatakanaBtn = document.getElementById('quiz-all-katakana-btn');
        const quizMainHiraganaBtn = document.getElementById('quiz-main-hiragana-btn');
        const quizMainKatakanaBtn = document.getElementById('quiz-main-katakana-btn');
        const quizDakuHiraganaBtn = document.getElementById('quiz-daku-hiragana-btn');
        const quizDakuKatakanaBtn = document.getElementById('quiz-daku-katakana-btn');
        
        const numberQuizBtn = document.getElementById('number-quiz-btn');

        const hiraganaBtn = document.getElementById('hiragana-btn');
        const katakanaBtn = document.getElementById('katakana-btn');
        const quitBtn = document.getElementById('quit-btn');
        
        const repeatAllBtn = document.getElementById('repeat-all-btn');
        const repeatMistakesBtn = document.getElementById('repeat-mistakes-btn');
        const mainMenuBtn = document.getElementById('main-menu-btn');

        const scoreEl = document.getElementById('score');
        const progressEl = document.getElementById('progress');
        const charDisplay = document.getElementById('char-display');
        const quizForm = document.getElementById('quiz-form');
        const answerInput = document.getElementById('answer-input');
        const feedback = document.getElementById('feedback');
        
        const finalScoreEl = document.getElementById('final-score');
        const totalQuestionsEl = document.getElementById('total-questions');

        const hintBtn = document.getElementById('hint-btn');
        const hintDisplay = document.getElementById('hint-display');
        const submitBtn = document.getElementById('submit-btn');

        // --- State ---
        let currentQuizData = {};
        let quizBank = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let totalQuestions = 0;
        let hintRevealed = ''; 
        let masterPracticeList = []; 
        let currentPracticeList = []; 
        let currentMode = ''; 
        let isPracticeRound = false; 

        // --- Functions ---

        /**
         * Shuffles an array in place.
         * @param {Array} array The array to shuffle.
         */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        
        /**
         * Converts Romaji to Hiragana for loose checking in number mode.
         * Simplistic, does not handle sokuon (double consonants) or prolonged vowels.
         */
        function romajiToHiragana(romaji) {
            // Only necessary for the number quiz where answers are strictly hiragana.
            const hiraMap = {
                'a': 'あ', 'i': 'い', 'u': 'う', 'e': 'え', 'o': 'お',
                'ka': 'か', 'ki': 'き', 'ku': 'く', 'ke': 'け', 'ko': 'こ',
                'sa': 'さ', 'shi': 'し', 'su': 'す', 'se': 'せ', 'so': 'そ',
                'ta': 'た', 'chi': 'ち', 'tsu': 'つ', 'te': 'て', 'to': 'と',
                'na': 'な', 'ni': 'に', 'nu': 'ぬ', 'ne': 'ね', 'no': 'の',
                'ha': 'は', 'hi': 'ひ', 'fu': 'ふ', 'he': 'へ', 'ho': 'ほ',
                'ma': 'ま', 'mi': 'み', 'mu': 'む', 'me': 'め', 'mo': 'も',
                'ya': 'や', 'yu': 'ゆ', 'yo': 'よ',
                'ra': 'ら', 'ri': 'り', 'ru': 'る', 're': 'れ', 'ro': 'ろ',
                'wa': 'わ', 'wo': 'を', 'n': 'ん',
                
                // Units
                'juu': 'じゅう', 'hyaku': 'ひゃく', 'sen': 'せん', 
                'man': 'まん', 'oku': 'おく', 'chou': 'ちょう', 
                
                // Euphony
                'sanbyaku': 'さんびゃく', 'roppyaku': 'ろっぴゃく', 'happyaku': 'はっぴゃく',
                'sanzen': 'さんぜん', 'hassen': 'はっせん',

                // Digits
                'ichi': 'いち', 'ni': 'に', 'san': 'さん', 'yon': 'よん', 
                'go': 'ご', 'roku': 'ろく', 'nana': 'なな', 'hachi': 'はち', 'kyuu': 'きゅう',
                'zero': 'ゼロ'
            };

            // This is a highly complex task. For the purpose of the quiz, we will only allow the 
            // user to match the strict hiragana answer, but this function is a reminder of the need
            // for strict matching when the requirement is 'strictly in hiragana'.
            // However, to make the number quiz slightly more forgiving, we will accept Romaji if it 
            // converts to the correct hiragana string using a simple lookup/replace.

            let hiragana = romaji;
            // Simplified Romaji to Hiragana conversion (not robust for all of Romaji)
            // It will attempt to match words in the hiragana answer.
            for (const [romajiWord, hiraWord] of Object.entries(hiraMap)) {
                // Use a simple replace method (not ideal for complex Romaji, but sufficient for number names)
                const regex = new RegExp(romajiWord, 'g');
                hiragana = hiragana.replace(regex, hiraWord);
            }

            return hiragana;
        }

        function startQuiz(mode, customBank = null, customData = null) {
            currentMode = mode; 
            isPracticeRound = (customBank !== null); 

            // 1. Set up quiz data
            if (customData) {
                currentQuizData = { ...customData };
            } else if (mode === 'numbers' && !isPracticeRound) {
                currentQuizData = generateBigNumberData(15);
            } else if (mode === 'hiragana') {
                currentQuizData = { ...hiraganaData };
            } else if (mode === 'katakana') {
                currentQuizData = { ...katakanaData };
            }

            // 2. Create and shuffle quiz bank
            quizBank = customBank ? [...customBank] : Object.keys(currentQuizData);
            shuffleArray(quizBank);

            // 3. Reset state
            currentQuestionIndex = 0;
            score = 0;
            totalQuestions = quizBank.length;
            
            if (!isPracticeRound) {
                masterPracticeList = []; 
            }
            currentPracticeList = []; 

            // 4. Update UI
            modeSelection.classList.add('hidden');
            resultsScreen.classList.add('hidden');
            hiraganaRowSelection.classList.add('hidden'); 
            katakanaRowSelection.classList.add('hidden'); 
            quizScreen.classList.remove('hidden');
            
            // Adjust input placeholder for number quiz
            if (currentMode === 'numbers') {
                 document.querySelector('label[for="answer-input"]').textContent = 'Type the answer in hiragana (e.g. いちまん)';
                 answerInput.placeholder = 'e.g. いちまん';
            } else {
                 document.querySelector('label[for="answer-input"]').textContent = 'Type the romaji (letters)';
                 answerInput.placeholder = 'e.g. ka';
            }


            updateScoreboard();
            loadNextQuestion();
            answerInput.focus();
        }

        function loadNextQuestion() {
            feedback.innerHTML = '&nbsp;';
            feedback.className = 'mt-4 h-6 text-lg font-medium text-center';
            answerInput.value = '';
            answerInput.disabled = false;
            answerInput.focus();

            hintRevealed = '';
            hintDisplay.innerHTML = '&nbsp;';
            hintBtn.disabled = false;
            submitBtn.disabled = false;

            if (currentQuestionIndex < totalQuestions) {
                const char = quizBank[currentQuestionIndex];
                charDisplay.textContent = char;
                
                // Adjust font size for numbers/long text
                if (currentMode === 'numbers') {
                    if (char.length > 14) {
                        charDisplay.style.fontSize = '3rem';
                    } else if (char.length > 10) {
                        charDisplay.style.fontSize = '4rem';
                    } else if (char.length > 6) {
                        charDisplay.style.fontSize = '6rem';
                    } else {
                        charDisplay.style.fontSize = '8rem';
                    }
                } else {
                    charDisplay.style.fontSize = '10rem';
                }


                updateScoreboard();
            } else {
                showResults();
            }
        }

        function updateScoreboard() {
            scoreEl.textContent = score;
            // +1 because it shows the *next* question number
            progressEl.textContent = `${currentQuestionIndex + 1} / ${totalQuestions}`;
            if (currentQuestionIndex >= totalQuestions) {
                progressEl.textContent = `${totalQuestions} / ${totalQuestions}`;
            }
        }

        function handleAnswerSubmit(e) {
            e.preventDefault();
            if (answerInput.disabled) return; 

            const correctAnswer = currentQuizData[quizBank[currentQuestionIndex]];
            let userAnswer = answerInput.value.trim().toLowerCase().replace(/\s+/g, '');
            
            let isCorrect = false;

            if (currentMode === 'numbers') {
                // Strict hiragana check for number mode
                isCorrect = userAnswer === correctAnswer;
            } else {
                // Romaji check for kana mode
                isCorrect = userAnswer === correctAnswer;
            }

            if (isCorrect) {
                score++;
                feedback.textContent = 'Correct!';
                feedback.className = 'mt-4 h-6 text-lg font-bold text-center text-green-400';
            } else {
                let displayAnswer = currentMode === 'numbers' ? correctAnswer : correctAnswer;

                feedback.innerHTML = `Incorrect! Answer: <span class="font-bold text-yellow-400">${displayAnswer}</span>`;
                feedback.className = 'mt-4 h-6 text-lg font-medium text-center text-red-400';
                
                if (!currentPracticeList.includes(quizBank[currentQuestionIndex])) {
                    currentPracticeList.push(quizBank[currentQuestionIndex]);
                }
            }

            scoreEl.textContent = score;
            
            answerInput.disabled = true;
            hintBtn.disabled = true;
            submitBtn.disabled = true;
            currentQuestionIndex++;

            setTimeout(() => {
                loadNextQuestion();
            }, 1800); 
        }

        function showResults() {
            masterPracticeList = [...currentPracticeList];

            finalScoreEl.textContent = score;
            totalQuestionsEl.textContent = totalQuestions;
            quizScreen.classList.add('hidden');
            resultsScreen.classList.remove('hidden');

            repeatMistakesBtn.textContent = `Practice Mistakes (${masterPracticeList.length})`;
            repeatMistakesBtn.disabled = masterPracticeList.length === 0;
        }

        function showMenu() {
            resultsScreen.classList.add('hidden');
            quizScreen.classList.add('hidden');
            hiraganaRowSelection.classList.add('hidden'); 
            katakanaRowSelection.classList.add('hidden'); 
            modeSelection.classList.remove('hidden');
        }

        function showHint() {
            const correctChar = quizBank[currentQuestionIndex];
            const correctAnswer = currentQuizData[correctChar];

            if (hintRevealed === '' && !currentPracticeList.includes(correctChar)) {
                currentPracticeList.push(correctChar);
            }

            if (hintRevealed === '') {
                // First hint: reveal the first character/syllable
                hintRevealed = correctAnswer.slice(0, 1) + '...';
            } else if (hintRevealed.endsWith('...')) {
                // Subsequent hints: reveal more, up to about 50%
                let currentLength = hintRevealed.length - 3;
                let targetLength = Math.ceil(correctAnswer.length / 2);
                let nextReveal = correctAnswer.slice(0, Math.min(targetLength, currentLength + 2));
                
                if (nextReveal.length < correctAnswer.length) {
                    hintRevealed = nextReveal + '...';
                } else {
                    hintRevealed = correctAnswer;
                }
            }

            hintDisplay.textContent = hintRevealed;

            if (hintRevealed === correctAnswer) {
                hintBtn.disabled = true;
            }
        }

        // --- Event Listeners ---
        hiraganaBtn.addEventListener('click', () => {
            modeSelection.classList.add('hidden');
            hiraganaRowSelection.classList.remove('hidden');
        });
        katakanaBtn.addEventListener('click', () => {
            modeSelection.classList.add('hidden');
            katakanaRowSelection.classList.remove('hidden');
        });
        
        hiraganaBackBtn.addEventListener('click', showMenu);
        quizAllHiraganaBtn.addEventListener('click', () => startQuiz('hiragana'));
        quizMainHiraganaBtn.addEventListener('click', () => startQuiz('hiragana', mainHiraganaChars));
        quizDakuHiraganaBtn.addEventListener('click', () => startQuiz('hiragana', dakuHiraganaChars));

        katakanaBackBtn.addEventListener('click', showMenu);
        quizAllKatakanaBtn.addEventListener('click', () => startQuiz('katakana'));
        quizMainKatakanaBtn.addEventListener('click', () => startQuiz('katakana', mainKatakanaChars));
        quizDakuKatakanaBtn.addEventListener('click', () => startQuiz('katakana', dakuKatakanaChars));

        numberQuizBtn.addEventListener('click', () => {
            startQuiz('numbers');
        });

        quizForm.addEventListener('submit', handleAnswerSubmit);
        quitBtn.addEventListener('click', showMenu);
        hintBtn.addEventListener('click', showHint);
        
        repeatAllBtn.addEventListener('click', () => {
            startQuiz(currentMode);
        });
        repeatMistakesBtn.addEventListener('click', () => {
            startQuiz(currentMode, masterPracticeList, currentQuizData);
        });
        mainMenuBtn.addEventListener('click', showMenu);

    </script>
</body>
</html>